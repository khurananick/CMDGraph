<html>
<head>
  <script>
    window.Get = (function() {
      var query = window.location.search.substring(1);
      var raw_vars = query.split("&");
      var params = {};
      for(var key in raw_vars) {
        param = raw_vars[key].split("=");
        variable = param[0];
        value = param[1];
        if(variable) {
          params[variable] = decodeURIComponent(value);
        }
      }
      return params;
    })();
    window.CompiledQuery = function(obj) {
      var str = "";
      for(var key in obj) {
        if(str !== "")
          str += "&";
        str += key + "=" + obj[key];
      }
      return "?" + str;
    };
    window.CompiledHref = function(obj) {
      return document.location.origin + document.location.pathname + CompiledQuery(obj);
    };
  </script>
</head>
<body>
  <div id="people">
  </div>
  <script>
    const div = document.getElementById("people");
    function createListWithHeading(headingStr, list) {
      const h3 = document.createElement("h3");
      h3.textContent = headingStr;
      const ul = document.createElement("ul");
      for(const item of list) {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = `/cmdbuild/ui/graph.html?person_id=${item._id}`;
        a.textContent = `${item.last_name}, ${item.first_name}`;
        li.append(a);
        ul.append(li);
      }
      div.append(h3);
      div.append(ul);
    }

    (async function() {
      const peopleAjax = await fetch('/cmdbuild/services/rest/v3/classes/Person/cards');
      const peopleJson = await peopleAjax.json();
      console.log(peopleJson);

      if(Get.person_id) {
        const response = await fetch(`/cmdbuild/services/rest/v3/classes/Person/cards/${Get.person_id}/relations`);
        const json = await response.json();
        console.log(json);

        const structuredList = {};
        for(const person of json.data) {
          const key = (function() {
            return person._type == "ManagerMapping" ? `${person._type} - ${person._direction}` : `${person._type}`;
          })();
          if(!structuredList[key])
            structuredList[key] = [];
          const personRecord = (function() {
            for(const p of peopleJson.data)
              if(p.Code == person._destinationCode)
                return p;
          })();
          structuredList[key].push(personRecord);
        }
        for(const i in structuredList) {
          createListWithHeading(i, structuredList[i]);
        }
      }
      else {
        createListWithHeading("People", peopleJson.data);
      }
    })();
  </script>
</body>
</html>
